<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Stxxl: algo/test_stable_ksort1.cpp</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>algo/test_stable_ksort1.cpp</h1>This is an example of how to use <code><a class="el" href="group__stlalgo.html#g5548420de9460c2654c7346e09f340a2" title="External sorting routine for records with keys.">stxxl::ksort()</a></code> algorithm<p>
<div class="fragment"><pre class="fragment"><span class="comment">/***************************************************************************</span>
<span class="comment"> *            test_stable_ksort.cpp</span>
<span class="comment"> *</span>
<span class="comment"> *  Thu Feb  6 11:46:53 2003</span>
<span class="comment"> *  Copyright  2003  Roman Dementiev</span>
<span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
<span class="comment"> ****************************************************************************/</span>


<span class="comment">//#define COUNT_WAIT_TIME</span>

<span class="comment">// #define PLAY_WITH_OPT_PREF</span>


<span class="preprocessor">#include "stxxl/mng"</span>
<span class="preprocessor">#include "stxxl/stable_ksort"</span>
<span class="preprocessor">#include "stxxl/vector"</span>
<span class="preprocessor">#include "stxxl/random"</span>


<span class="preprocessor">#ifndef RECORD_SIZE</span>
<span class="preprocessor"></span><span class="preprocessor"> #define RECORD_SIZE 128</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="keyword">struct </span>my_type
{
    <span class="keyword">typedef</span> stxxl::uint64 key_type;

    key_type _key;
    <span class="keywordtype">char</span> _data[RECORD_SIZE - <span class="keyword">sizeof</span>(key_type)];
    key_type key()<span class="keyword"> const</span>
<span class="keyword">    </span>{
        <span class="keywordflow">return</span> _key;
    }

    my_type() { };
    my_type(key_type __key) : _key(__key) { };

    <span class="keyword">static</span> my_type min_value()
    {
        <span class="keywordflow">return</span> my_type(0);
    }
    <span class="keyword">static</span> my_type max_value()
    {
        <span class="keywordflow">return</span> my_type(0xffffffff);
    }
};

<span class="keywordtype">bool</span> operator &lt; (<span class="keyword">const</span> my_type &amp; a, <span class="keyword">const</span> my_type &amp; b)
{
    <span class="keywordflow">return</span> a.key() &lt; b.key();
}



<span class="preprocessor">#define MB (1024 * 1024)</span>
<span class="preprocessor"></span>

<span class="keyword">struct </span>zero
{
    <span class="keywordtype">unsigned</span> operator ()  ()
    {
        <span class="keywordflow">return</span> 0;
    }
};

<span class="keyword">template</span> &lt;<span class="keyword">typename</span> alloc_strategy_type, <span class="keywordtype">unsigned</span> block_size&gt;
<span class="keywordtype">void</span> test(stxxl::int64 records_to_sort, <span class="keywordtype">unsigned</span> memory_to_use)
{
    <span class="keyword">typedef</span> stxxl::vector &lt; my_type, 2, stxxl::lru_pager &lt; 8 &gt;, block_size, alloc_strategy_type &gt; vector_type;

    memory_to_use = div_and_round_up(memory_to_use, vector_type::block_type::raw_size) * vector_type::block_type::raw_size;

    vector_type v(records_to_sort);
    <span class="keywordtype">unsigned</span> ndisks = stxxl::config::get_instance()-&gt;disks_number();
    STXXL_MSG(<span class="stringliteral">"Sorting "</span> &lt;&lt; records_to_sort &lt;&lt; <span class="stringliteral">" records of size "</span> &lt;&lt; <span class="keyword">sizeof</span>(my_type) );
    STXXL_MSG(<span class="stringliteral">"Total volume "</span> &lt;&lt; (records_to_sort * <span class="keyword">sizeof</span>(my_type)) / MB &lt;&lt; <span class="stringliteral">" MB"</span>);
    STXXL_MSG(<span class="stringliteral">"Using "</span> &lt;&lt; memory_to_use / MB &lt;&lt; <span class="stringliteral">" MB"</span>);
    STXXL_MSG(<span class="stringliteral">"Using "</span> &lt;&lt; ndisks &lt;&lt; <span class="stringliteral">" disks"</span>);
    STXXL_MSG(<span class="stringliteral">"Using "</span> &lt;&lt; alloc_strategy_type::name() &lt;&lt; <span class="stringliteral">" allocation strategy "</span>);
    STXXL_MSG(<span class="stringliteral">"Block size "</span> &lt;&lt; vector_type::block_type::raw_size / 1024 &lt;&lt; <span class="stringliteral">" KB"</span>);
    STXXL_MSG(<span class="stringliteral">"Seed "</span> &lt;&lt; stxxl::ran32State );
    STXXL_MSG(<span class="stringliteral">"Filling vector..."</span>);

    <a name="a0"></a><a class="code" href="group__stlalgo.html#g1dd99bb947279a24bc397960e214e2c2" title="External equivalent of std::generate.">std::generate</a>(v.begin(), v.end(), stxxl::random_number64());
    <span class="comment">//std::generate(v.begin(),v.end(),zero());</span>

    STXXL_MSG(<span class="stringliteral">"Sorting vector..."</span>);

    stxxl::stable_ksort(v.begin(), v.end(), memory_to_use);

    <span class="comment">//STXXL_MSG("Checking order...");</span>
    <span class="comment">//STXXL_MSG(((stxxl::is_sorted(v.begin(),v.end()))?"OK":"WRONG" ));</span>
}

<span class="keyword">template</span> &lt;<span class="keywordtype">unsigned</span> block_size&gt;
<span class="keywordtype">void</span> test_all_strategies(
    stxxl::int64 records_to_sort,
    <span class="keywordtype">unsigned</span> memory_to_use,
    <span class="keywordtype">int</span> strategy)
{
    <span class="keywordflow">switch</span> (strategy)
    {
    <span class="keywordflow">case</span> 0:
        test&lt;stxxl::striping, block_size&gt;(records_to_sort, memory_to_use);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 1:
        test&lt;stxxl::SR, block_size&gt;(records_to_sort, memory_to_use);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
        test&lt;stxxl::FR, block_size&gt;(records_to_sort, memory_to_use);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 3:
        test&lt;stxxl::RC, block_size&gt;(records_to_sort, memory_to_use);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        STXXL_ERRMSG(<span class="stringliteral">"Unknown allocation strategy: "</span> &lt;&lt; strategy &lt;&lt; <span class="stringliteral">", aborting"</span>);
        abort();
    }
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> * argv[])
{
    <span class="keywordflow">if</span> (argc &lt; 6)
    {
        STXXL_ERRMSG(<span class="stringliteral">"Usage: "</span> &lt;&lt; argv[0] &lt;&lt;
                     <span class="stringliteral">" &lt;MB to sort&gt; &lt;MB to use&gt; &lt;alloc_strategy&gt; &lt;blk_size&gt; &lt;seed&gt;"</span>);
        <span class="keywordflow">return</span> -1;
    }

    stxxl::int64 n_records = (atoll(argv[1]) * MB) / <span class="keyword">sizeof</span>(my_type);
    <span class="keywordtype">int</span> sort_mem = atoi(argv[2]) * MB;
    <span class="keywordtype">int</span> strategy = atoi(argv[3]);
    <span class="keywordtype">int</span> block_size = atoi(argv[4]);
    stxxl::ran32State = strtoul(argv[5], NULL, 10     );

    <span class="keywordflow">switch</span> (block_size)
    {
    <span class="keywordflow">case</span> 0:
        test_all_strategies &lt; (128 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 1:
        test_all_strategies &lt; (256 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
        test_all_strategies &lt; (512 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 3:
        test_all_strategies &lt; (1024 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 4:
        test_all_strategies &lt; (2 * 1024 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 5:
        test_all_strategies &lt; (4 * 1024 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 6:
        test_all_strategies &lt; (8 * 1024 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 7:
        test_all_strategies &lt; (16 * 1024 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 8:
        test_all_strategies &lt; (640 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 9:
        test_all_strategies &lt; (768 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 10:
        test_all_strategies &lt; (896 * 1024) &gt; (n_records, sort_mem, strategy);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        STXXL_ERRMSG(<span class="stringliteral">"Unknown block size: "</span> &lt;&lt; block_size &lt;&lt; <span class="stringliteral">", aborting"</span>);
        abort();
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Apr 21 06:44:34 2010 for Stxxl by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
