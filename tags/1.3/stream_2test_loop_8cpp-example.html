<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Stxxl: stream/test_loop.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Stxxl
   &#160;<span id="projectnumber">1.3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">stream/test_loop.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>This is an example of how to use some basic algorithms from the stream package to form a loop iterating over the data. Some input is generated, sorted, some elements are filtered out. The remaining elements are transformed, sorted and processed in the next pass. The loop will terminate if at most one element remains. A split sorter is used to cut the data flow (and type dependency) cycle.</p>
<div class="fragment"><div class="line"><span class="comment">/***************************************************************************</span></div>
<div class="line"><span class="comment"> *  stream/test_loop.cpp</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  example for building a loop of stream operations</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  Part of the STXXL. See http://stxxl.sourceforge.net</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  Copyright © 2011 Jaroslaw Fedorowicz &lt;fedorow@cs.uni-frankfurt.de&gt;</span></div>
<div class="line"><span class="comment"> *  Copyright © 2011 Andreas Beckmann &lt;beckmann@cs.uni-frankfurt.de&gt;</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><span class="comment"> *  (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><span class="comment"> *  http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><span class="comment"> **************************************************************************/</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stxxl/mng&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stxxl/vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stxxl/stream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> std::cout;</div>
<div class="line"><span class="keyword">using</span> std::endl;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> stxxl::uint64 memory_to_use = 3ul * 1024 * 1024 * 1024;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> verbose;</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>random_generator</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> stxxl::random_number32::value_type value_type;</div>
<div class="line">    <span class="keyword">typedef</span> stxxl::uint64 size_type;</div>
<div class="line">    value_type current;</div>
<div class="line">    size_type count;</div>
<div class="line">    stxxl::random_number32 rnd;</div>
<div class="line"></div>
<div class="line">    random_generator(size_type _count) : count(_count)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (verbose) cout &lt;&lt; <span class="stringliteral">&quot;Random Stream: &quot;</span>;</div>
<div class="line">        current = rnd();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    value_type operator * ()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> current;</div>
<div class="line">    }</div>
<div class="line">    random_generator &amp; operator ++ ()</div>
<div class="line">    {</div>
<div class="line">        count--;</div>
<div class="line">        <span class="keywordflow">if</span> (verbose) {</div>
<div class="line">            cout &lt;&lt; current &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (empty()) cout &lt;&lt; endl;</div>
<div class="line">        }</div>
<div class="line">        current = rnd();</div>
<div class="line">        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">bool</span> empty()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> (count == 0);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> value_type&gt;</div>
<div class="line"><span class="keyword">struct </span>Cmp : std::binary_function&lt;value_type, value_type, bool&gt;</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span> operator () (<span class="keyword">const</span> value_type &amp; a, <span class="keyword">const</span> value_type &amp; b)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> a &lt; b;</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">static</span> value_type min_value()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> value_type((std::numeric_limits&lt;value_type&gt;::min)());</div>
<div class="line">    }</div>
<div class="line">    <span class="keyword">static</span> value_type max_value()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> value_type((std::numeric_limits&lt;value_type&gt;::max)());</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input&gt;</div>
<div class="line"><span class="keyword">struct </span>filter</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> Input::value_type value_type;</div>
<div class="line">    <span class="keyword">typedef</span> stxxl::uint64 size_type;</div>
<div class="line">    Input &amp; input;</div>
<div class="line">    value_type filter_value;</div>
<div class="line">    size_type &amp; counter;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> apply_filter()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">while</span> (!input.empty() &amp;&amp; *input == filter_value) {</div>
<div class="line">            ++input;</div>
<div class="line">            counter++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    filter(Input &amp; _input, value_type _filter_value, size_type &amp; _counter) : input(_input), filter_value(_filter_value), counter(_counter)</div>
<div class="line">    {</div>
<div class="line">        apply_filter();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> value_type operator * ()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> *input;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    filter &amp; operator ++ ()</div>
<div class="line">    {</div>
<div class="line">        ++input;</div>
<div class="line">        apply_filter();</div>
<div class="line">        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> empty()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> input.empty();</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input&gt;</div>
<div class="line"><span class="keyword">struct </span>output</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> Input::value_type value_type;</div>
<div class="line">    Input &amp; input;</div>
<div class="line"></div>
<div class="line">    output(Input &amp; _input) : input(_input) { }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> value_type operator * ()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> *input;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    output &amp; operator ++ ()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (verbose) cout &lt;&lt; *input &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line">        ++input;</div>
<div class="line">        <span class="keywordflow">if</span> (empty() &amp;&amp; verbose)</div>
<div class="line">            cout &lt;&lt; endl;</div>
<div class="line">        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> empty()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> input.empty();</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input&gt;</div>
<div class="line"><span class="keyword">struct </span>shuffle</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> Input::value_type value_type;</div>
<div class="line">    Input &amp; input;</div>
<div class="line">    value_type current, next;</div>
<div class="line">    <span class="keywordtype">bool</span> even, is_empty;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// from http://graphics.stanford.edu/~seander/bithacks.html#CountBitsSetKernighan</span></div>
<div class="line">    <span class="keywordtype">int</span> count_bits(stxxl::uint64 v)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> c;</div>
<div class="line">        <span class="keywordflow">for</span> (c = 0; v; c++) {</div>
<div class="line">            v &amp;= v - 1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> c;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> apply_shuffle()</div>
<div class="line">    {</div>
<div class="line">        is_empty = input.empty();</div>
<div class="line">        <span class="keywordflow">if</span> (!is_empty) {</div>
<div class="line">            current = *input;</div>
<div class="line">            ++input;</div>
<div class="line">            <span class="keywordflow">if</span> (!input.empty()) {</div>
<div class="line">                STXXL_STATIC_ASSERT(<span class="keyword">sizeof</span>(value_type) == 4);</div>
<div class="line">                stxxl::uint64 combined = current;</div>
<div class="line">                combined = combined &lt;&lt; 32 | *input;</div>
<div class="line">                combined = (1ul &lt;&lt; count_bits(combined)) - 1;</div>
<div class="line">                current = combined &gt;&gt; 32;</div>
<div class="line">                next = combined;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    shuffle(Input &amp; _input) : input(_input), current(0), next(0), even(true), is_empty(false)</div>
<div class="line">    {</div>
<div class="line">        apply_shuffle();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    value_type operator * ()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> current;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    shuffle &amp; operator ++ ()</div>
<div class="line">    {</div>
<div class="line">        even = !even;</div>
<div class="line">        is_empty = input.empty();</div>
<div class="line">        <span class="keywordflow">if</span> (even) {</div>
<div class="line">            ++input;</div>
<div class="line">            apply_shuffle();</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            current = next;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> empty()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> is_empty;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> random_generator input_generator_type;</div>
<div class="line"><span class="keyword">typedef</span> Cmp&lt;input_generator_type::value_type&gt; cmp;</div>
<div class="line"><span class="keyword">typedef</span> stxxl::stream::runs_creator&lt;input_generator_type, cmp&gt; runs_creator_type0;</div>
<div class="line"><span class="keyword">typedef</span> runs_creator_type0::sorted_runs_type sorted_runs_type;</div>
<div class="line"><span class="keyword">typedef</span> stxxl::stream::runs_merger&lt;sorted_runs_type, cmp&gt; runs_merger_type;</div>
<div class="line"><span class="keyword">typedef</span> output&lt;runs_merger_type&gt; output_type;</div>
<div class="line"><span class="keyword">typedef</span> filter&lt;output_type&gt; filter_type0;</div>
<div class="line"><span class="keyword">typedef</span> filter&lt;filter_type0&gt; filter_type1;</div>
<div class="line"><span class="keyword">typedef</span> shuffle&lt;filter_type1&gt; shuffle_type;</div>
<div class="line"><span class="keyword">typedef</span> stxxl::stream::runs_creator&lt;shuffle_type, cmp&gt; runs_creator_type1;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> ** argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 2) {</div>
<div class="line">        cout &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; count [Options]\nOptions: -v \t prints elements of each iteration\n&quot;</span>;</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    stxxl::block_manager::get_instance();</div>
<div class="line"></div>
<div class="line">    verbose = (argc == 3) &amp;&amp; !strcmp(argv[2], <span class="stringliteral">&quot;-v&quot;</span>);</div>
<div class="line"></div>
<div class="line">    stxxl::uint64 total = atoi(argv[1]);</div>
<div class="line"></div>
<div class="line">    input_generator_type input_stream(total);</div>
<div class="line"></div>
<div class="line">    runs_creator_type0 runs_creator(input_stream, cmp(), memory_to_use);</div>
<div class="line"></div>
<div class="line">    sorted_runs_type sorted_runs = runs_creator.result();</div>
<div class="line"></div>
<div class="line">    stxxl::uint64 counter = 0;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; counter &lt; total - 1; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (verbose) cout &lt;&lt; <span class="stringliteral">&quot;Iteration &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;: &quot;</span>;</div>
<div class="line"></div>
<div class="line">        runs_merger_type runs_merger(sorted_runs, cmp(), memory_to_use);</div>
<div class="line"></div>
<div class="line">        output_type output_stream(runs_merger);</div>
<div class="line"></div>
<div class="line">        filter_type0 filter0(output_stream, 0, counter);</div>
<div class="line"></div>
<div class="line">        filter_type1 filter1(filter0, filter_type1::value_type(-1), counter);</div>
<div class="line"></div>
<div class="line">        shuffle_type shuffled_stream(filter1);</div>
<div class="line"></div>
<div class="line">        runs_creator_type1 runs_creator(shuffled_stream, cmp(), memory_to_use);</div>
<div class="line"></div>
<div class="line">        sorted_runs = runs_creator.result();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    runs_merger_type runs_merger(sorted_runs, cmp(), memory_to_use);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (!runs_merger.empty()) {</div>
<div class="line">        <span class="keywordflow">if</span> (verbose) cout &lt;&lt; <span class="stringliteral">&quot;Iteration &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; *runs_merger &lt;&lt; endl;</div>
<div class="line">        ++runs_merger;</div>
<div class="line">    }</div>
<div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;\nIteration needed: &quot;</span> &lt;&lt; i &lt;&lt; endl;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// vim: et:ts=4:sw=4</span></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
